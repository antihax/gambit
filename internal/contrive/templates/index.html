{{define "head"}}

{{end}}

{{define "body"}}
<script>
    function gambitOutputRow(row, index) {
        var classes = [
            'bg-primary',
            'bg-info',
            'bg-warning',
            'bg-danger'
        ];
        switch (row.level) {
            case "debug":
                return { classes: classes[0] }
            case "warn":
                return { classes: classes[1] }
            case "error":
                return { classes: classes[2] }
            default:
                return {}
        }
        return {}
    }

    $(document).ready(function () {
        var data = $.getJSON("/api/recent", function (data) {
            data.forEach((row, index) => {
                data[index] = Object.keys(row).reduce((prev, current) =>
                    ({ ...prev, [current.replace("gambit.", "")]: row[current][0] }), {})
            });

            $('#output').DataTable({
                data: data,
                "scrollY": "400px",
                "scrollCollapse": true,
                "searching": false,
                "paging": false,
                "createdRow": function (row, data, dataIndex) {
                    switch (data.level) {
                        case "debug":
                            $(row).addClass('bg-primary')
                            break;
                        case "warn":
                            $(row).addClass('bg-warning')
                            break;
                        case "error":
                            $(row).addClass('bg-danger')
                            break;
                    }
                },
                columns: [
                    { data: "hash" },
                    { data: "message" },
                    { data: "attacker" },
                    { data: "dstport" },
                    { data: "sequence", defaultContent: "-", },
                ]
            })

            // scroll to bottom
            var table = $('#output').DataTable();
            var scrollBody = $(table.table().node()).parent();
            scrollBody.scrollTop(scrollBody.get(0).scrollHeight);
        });
    });

    function connect() {
        var ws = new WebSocket('ws://' + document.location.host + '/api/recent-ws');
        ws.onerror = function () {
            ws.close();
        };
        ws.onclose = function (e) {
            console.log('Socket is closed. Reconnect will be attempted.', e.reason);
            this.close();
            connect();
        };
        ws.onmessage = function (msgevent) {
            var msg = JSON.parse(msgevent.data);

            // remove gambit. and flatten the array response
            msg = Object.keys(msg).reduce((prev, current) =>
                ({ ...prev, [current.replace("gambit.", "")]: msg[current][0] }), {})

            $('#output').DataTable().row.add(msg).draw(false);
            

        };
    };
    connect()
</script>
<table class="thintable display" id="output">

</table>
{{end}}